<!doctype html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>لوحة التحكم</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <style>
        .hidden-row {
            display: none;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg">
        <div class="container">
            <a class="navbar-brand" href="/">لوحة تحكم المبيعات</a>
            <div class="collapse navbar-collapse">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item"><a class="nav-link" href="/">الرئيسية</a></li>
                </ul>
            </div>
        </div>
    </nav>
    <div class="container mt-4">
        <h1><i class="bi bi-speedometer2 me-2"></i>لوحة التحكم</h1>
        <div class="row">
            <div class="col-md-3 mb-3">
                <div class="card text-center">
                    <div class="card-body">
                        <i class="bi bi-currency-dollar kpi-icon"></i>
                        <h5 class="card-title">إجمالي المبيعات اليوم</h5>
                        <p class="card-text fw-bold">{{ total_sales_today }} جنيه</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="card text-center">
                    <div class="card-body">
                        <i class="bi bi-people kpi-icon"></i>
                        <h5 class="card-title">عدد العملاء</h5>
                        <p class="card-text fw-bold">{{ num_clients }}</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="card text-center">
                    <div class="card-body">
                        <i class="bi bi-star-fill kpi-icon"></i>
                        <h5 class="card-title">المنتج الأكثر مبيعاً</h5>
                        <p class="card-text fw-bold">{{ best_product }}</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="card text-center">
                    <div class="card-body">
                        <i class="bi bi-box-seam kpi-icon"></i>
                        <h5 class="card-title">المخزون المتبقي</h5>
                        <p class="card-text fw-bold">{{ total_remaining }} وحدة</p>
                    </div>
                </div>
            </div>
        </div>

        <h2 class="mt-4"><i class="bi bi-cart-fill me-2"></i>المبيعات</h2>
        <div class="table-responsive">
            <table class="table table-striped table-hover">
                <thead>
                    <tr>
                        <th>البائع</th>
                        <th>المنتج</th>
                        <th>الكمية</th>
                        <th>التاريخ</th>
                        <th>السعر</th>
                        <th>الإجمالي</th>
                    </tr>
                </thead>
                <tbody id="sales-table-body">
                    {% for sale in sales_table %}
                    <tr class="{% if loop.index > 6 %}hidden-row{% endif %}">
                        <td>{{ sale.salesperson }}</td>
                        <td>{{ sale.product }}</td>
                        <td>{{ sale.quantity }}</td>
                        <td>{{ sale.date }}</td>
                        <td>{{ sale.price | round(2) }} جنيه</td>
                        <td>{{ sale.total | round(2) }} جنيه</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            <button id="expand-btn" class="btn btn-primary">عرض المزيد</button>
        </div>

        <h2 class="mt-4"><i class="bi bi-archive-fill me-2"></i>المخزون</h2>
        <div class="table-responsive">
            <table class="table table-striped table-hover">
                <thead>
                    <tr>
                        <th>المنتج</th>
                        <th>المخزون الأولي</th>
                        <th>الوحدات المباعة</th>
                        <th>المخزون المتبقي</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in inventory_table %}
                    <tr>
                        <td><a href="/product/{{ item.id }}" class="text-decoration-none">{{ item.product }}</a></td>
                        <td>{{ item.initial_stock }}</td>
                        <td>{{ item.units_sold }}</td>
                        <td>{{ item.remaining_stock }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <h2 class="mt-4"><i class="bi bi-person-lines-fill me-2"></i>العملاء</h2>
        <div class="table-responsive">
            <table class="table table-striped table-hover">
                <thead>
                    <tr>
                        <th>اسم العميل</th>
                        <th>معلومات الاتصال</th>
                        <th>آخر منتج تم شراؤه</th>
                    </tr>
                </thead>
                <tbody>
                    {% for client in clients_table %}
                    <tr>
                        <td>{{ client.name }}</td>
                        <td>{{ client.contact }}</td>
                        <td>{{ client.last_product }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <h2 class="mt-4"><i class="bi bi-bar-chart-line-fill me-2"></i>إحصائيات ورسوم بيانية</h2>
        <div class="row">
            <div class="col-lg-6 mb-4">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">المبيعات حسب البائع</h5>
                        <canvas id="salesByPersonChart"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-lg-6 mb-4">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">المبيعات حسب المنتج</h5>
                        <canvas id="salesByProductChart"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-12">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">اتجاه المبيعات عبر الزمن</h5>
                        <canvas id="salesTrendChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        document.getElementById('expand-btn').addEventListener('click', function() {
            var hiddenRows = document.querySelectorAll('.hidden-row');
            var isExpanded = this.textContent === 'عرض أقل';

            hiddenRows.forEach(function(row) {
                row.style.display = isExpanded ? 'none' : 'table-row';
            });

            this.textContent = isExpanded ? 'عرض المزيد' : 'عرض أقل';
        });

        // Chart.js implementation
        const chartData = JSON.parse('{{ chart_data | safe }}');

        // Chart 1: Sales by Salesperson
        new Chart(document.getElementById('salesByPersonChart'), {
            type: 'bar',
            data: {
                labels: chartData.sales_by_person.labels,
                datasets: [{
                    label: 'إجمالي المبيعات',
                    data: chartData.sales_by_person.data,
                    backgroundColor: 'rgba(0, 170, 255, 0.5)',
                    borderColor: 'rgba(0, 170, 255, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                scales: {
                    y: { beginAtZero: true }
                }
            }
        });

        // Chart 2: Sales by Product
        new Chart(document.getElementById('salesByProductChart'), {
            type: 'pie',
            data: {
                labels: chartData.sales_by_product.labels,
                datasets: [{
                    data: chartData.sales_by_product.data,
                    backgroundColor: [
                        'rgba(255, 99, 132, 0.7)',
                        'rgba(54, 162, 235, 0.7)',
                        'rgba(255, 206, 86, 0.7)',
                        'rgba(75, 192, 192, 0.7)',
                        'rgba(153, 102, 255, 0.7)'
                    ]
                }]
            }
        });

        // Chart 3: Sales Trend
        new Chart(document.getElementById('salesTrendChart'), {
            type: 'line',
            data: {
                labels: chartData.sales_trend.labels,
                datasets: [{
                    label: 'إجمالي المبيعات اليومية',
                    data: chartData.sales_trend.data,
                    fill: false,
                    borderColor: 'rgba(75, 192, 192, 1)',
                    tension: 0.1
                }]
            },
            options: {
                scales: {
                    y: { beginAtZero: true }
                }
            }
        });
    </script>
</body>
</html>